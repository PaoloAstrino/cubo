name: CI Fast Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.txt
          pip install -r requirements/requirements-ci.txt
          pip install -r requirements/requirements-dev.txt
      
      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short --maxfail=5
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            .pytest_cache/
            test-results.xml

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.txt
          pip install -r requirements/requirements-ci.txt
          pip install -r requirements/requirements-dev.txt
      
      - name: Install FAISS CPU
        run: |
          pip install faiss-cpu
      
      - name: Run integration tests (quick)
        run: |
          pytest tests/integration/ -v --tb=short -m "not slow"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .pytest_cache/
            test-results.xml

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.txt
          pip install -r requirements/requirements-dev.txt
      
      - name: Check imports
        run: |
          python -c "import cubo; print('cubo imported successfully')"
      
      - name: Test CLI help
        run: |
          python scripts/run_beir_adapter.py --help || exit 0
      
      - name: Test config loading
        run: |
          python -c "import json; f=open('configs/config_local.json'); json.load(f); print('Config valid')"

  linting:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Run flake8
        run: |
          flake8 cubo/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: Run black (check only)
        run: |
          black --check cubo/ scripts/ || echo "Code formatting issues found"
      
      - name: Run isort (check only)
        run: |
          isort --check-only cubo/ scripts/ || echo "Import ordering issues found"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install bandit
        run: |
          pip install bandit
      
      - name: Run bandit security scan
        run: |
          bandit -r cubo/ -f json -o bandit_report.json || true
      
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit_report.json

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, smoke-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Unit tests: ${{ needs.unit-tests.result }}"
          echo "Integration tests: ${{ needs.integration-tests.result }}"
          echo "Smoke tests: ${{ needs.smoke-tests.result }}"
      
      - name: Fail if critical tests failed
        if: needs.unit-tests.result == 'failure'
        run: exit 1
