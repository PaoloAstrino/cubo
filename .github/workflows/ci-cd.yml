name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=term --cov-fail-under=85
          # Ensure new backend service tests are included
          python -m pytest tests/test_thread_manager.py tests/test_error_recovery.py tests/test_health_monitor.py tests/test_service_manager.py -v

      - name: Run GUI tests
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          python -c "from gui.main_window import CUBOGUI; print('GUI imports successfully')"
          python -c "from gui.components import DocumentWidget, QueryWidget; print('GUI components import successfully')"
          python -c "from gui.themes import ThemeManager; print('GUI themes import successfully')"

      - name: Run backend service tests
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          # Test service manager integration
          python -c "from src.service_manager import get_service_manager; sm = get_service_manager(); status = sm.get_system_status(); print(f'Service manager status: {status}'); sm.shutdown()"
          # Test thread manager
          python -c "from src.thread_manager import ThreadManager; tm = ThreadManager(max_workers=2); future = tm.submit_task(lambda: 42); result = future.result(); assert result == 42; tm.shutdown()"
          # Test error recovery
          python -c "from src.error_recovery import ErrorRecoveryManager; erm = ErrorRecoveryManager(); result = erm.execute_with_recovery('test', lambda: 'success'); assert result == 'success'"
          # Test health monitor
          python -c "from src.health_monitor import HealthMonitor; hm = HealthMonitor(); status = hm.get_health_status(); assert 'overall_status' in status"

      - name: Test GUI-backend integration
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          # Test that GUI properly integrates with service manager
          python -c "
          from gui.main_window import CUBOGUI
          from PySide6.QtWidgets import QApplication
          import sys

          # Create minimal QApplication for testing
          app = QApplication.instance()
          if app is None:
              app = QApplication(sys.argv)

          try:
              # Test GUI initialization with service manager
              gui = CUBOGUI()
              assert gui.service_manager is not None
              print('GUI-backend integration test passed')
              
              # Test service manager methods
              status = gui.service_manager.get_system_status()
              assert 'threads' in status
              assert 'health' in status
              assert 'errors' in status
              print('Service manager integration verified')
              
              gui.service_manager.shutdown(wait=True)
          finally:
              if app:
                  app.quit()
          "

      - name: Validate backend reliability features
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          python -c "
          # Comprehensive test of backend reliability features
          from src.service_manager import get_service_manager
          import time

          sm = get_service_manager()

          # Test error recovery with retry
          call_count = [0]
          def failing_operation():
              call_count[0] += 1
              if call_count[0] < 3:
                  raise ValueError('Temporary failure')
              return 'success'

          result = sm.execute_sync('document_processing', failing_operation)
          assert result == 'success'
          assert call_count[0] == 3
          print('Error recovery with retry: PASSED')

          # Test async execution
          future = sm.execute_async('llm_generation', lambda: 'async_result')
          async_result = future.result(timeout=5)
          assert async_result == 'async_result'
          print('Async execution: PASSED')

          # Test health monitoring
          status = sm.get_system_status()
          assert 'threads' in status
          assert 'health' in status
          assert 'errors' in status
          assert status['health']['overall_status'] in ['healthy', 'warning', 'critical']
          print('Health monitoring: PASSED')

          # Test thread pool management
          thread_status = status['threads']
          assert 'active_tasks' in thread_status
          assert 'max_workers' in thread_status
          print('Thread pool management: PASSED')

          sm.shutdown(wait=True)
          print('Backend reliability validation: ALL PASSED')
          "

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

      - name: Run linting (optional)
        run: |
          pip install flake8
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          # Lint new backend service files with stricter rules
          flake8 src/thread_manager.py src/error_recovery.py src/health_monitor.py src/service_manager.py --count --max-complexity=8 --max-line-length=100 --statistics

  build:
    runs-on: windows-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Build executable
        run: |
          pip install pyinstaller
          pyinstaller --onefile --exclude-module tensorflow --exclude-module tf_keras --exclude-module sklearn src/main.py --name cubo

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cubo-exe
          path: dist/cubo.exe
