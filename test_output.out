============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.3.5, pluggy-1.6.0 -- C:\Users\paolo\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\paolo\Desktop\cubo
configfile: pytest.ini
plugins: anyio-4.10.0, langsmith-0.3.11, asyncio-1.2.0, cov-7.0.0, mock-3.14.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/logging/test_logger_reconfig_and_trace.py::test_logger_reconfig_json_and_trace DEBUG: Captured lines: ['{"asctime": "2025-11-22 19:32:31,383", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"main started\\", \\"timestamp\\": \\"2025-11-22T18:32:31.383131Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,383", "levelname": "INFO", "name": "src.cubo.workers.thread_manager", "message": "ThreadManager initialized with 1 max workers and prefix \'cubo\'", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,383", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"Added health check: system_memory\\", \\"timestamp\\": \\"2025-11-22T18:32:31.383665Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,383", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"Added health check: system_cpu\\", \\"timestamp\\": \\"2025-11-22T18:32:31.383665Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"Added health check: disk_space\\", \\"timestamp\\": \\"2025-11-22T18:32:31.384175Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"HealthMonitor initialized\\", \\"timestamp\\": \\"2025-11-22T18:32:31.384175Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"Added health check: thread_pool\\", \\"timestamp\\": \\"2025-11-22T18:32:31.384175Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"Added health check: error_recovery\\", \\"timestamp\\": \\"2025-11-22T18:32:31.384175Z\\", \\"level\\": \\"info\\"}", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "src.cubo.services.service_manager", "message": "ServiceManager initialized", "trace_id": ""}', '{"asctime": "2025-11-22 19:32:31,384", "levelname": "INFO", "name": "cubo", "message": "{\\"event\\": \\"background op\\", \\"timestamp\\": \\"2025-11-22T18:32:31.384741Z\\", \\"level\\": \\"info\\", \\"trace_id\\": \\"04fd3399-4a68-4b02-9259-0e02cadfa548\\"}", "trace_id": ""}']
FAILED

================================== FAILURES ===================================
_____________________ test_logger_reconfig_json_and_trace _____________________

tmp_path = WindowsPath('C:/Users/paolo/AppData/Local/Temp/pytest-of-paolo/pytest-229/test_logger_reconfig_json_and_0')

    def test_logger_reconfig_json_and_trace(tmp_path):
        # config to write json logs
        log_file = tmp_path / 'log.jsonl'
        config.set('logging.log_file', str(log_file))
        config.set('logging.format', 'json')

        # Re-init the logger
        logger_instance.shutdown()
        logger_instance._setup_logging()

        # Acquire the reconfigured logger and write a main-thread log
        log = logger_instance.get_logger()
        log.info('main started')

        # Emit a log from a background operation via ServiceManager which should attach trace_id
        svc = ServiceManager(max_workers=1)

        def op():
            from src.cubo.utils.logging_context import get_current_trace_id
            from src.cubo.utils.logger import logger as inlogger
            inlogger.info('background op')
            return get_current_trace_id()

        fut = svc.execute_async('document_processing', op, with_retry=False)
        trace = fut.result(timeout=5)
        assert trace

        # Allow flush
        time.sleep(0.05)

        with open(log_file, 'r', encoding='utf-8') as f:
            lines = [l.strip() for l in f.readlines() if l.strip()]

        assert lines
        print(f"DEBUG: Captured lines: {lines}")
        # Confirm at least one JSON line has message and trace_id
        found_main = found_bg = False
        for l in lines:
            rec = json.loads(l)
            if rec.get('message') == 'main started':
                found_main = True
                assert 'trace_id' in rec
            if rec.get('message') == 'background op':
                found_bg = True
                # Trace should be in log; we assert presence of field (non-empty may depend on
                # queue handler behavior) and that operation returned a trace.
                assert 'trace_id' in rec
>       assert found_main and found_bg
E       assert (False)

tests\logging\test_logger_reconfig_and_trace.py:57: AssertionError
------------------------------ Captured log call ------------------------------
INFO     cubo:test_logger_reconfig_and_trace.py:22 {"event": "main started", "timestamp": "2025-11-22T18:32:31.383131Z", "level": "info"}
INFO     src.cubo.workers.thread_manager:thread_manager.py:26 ThreadManager initialized with 1 max workers and prefix 'cubo'
INFO     cubo:health_monitor.py:83 {"event": "Added health check: system_memory", "timestamp": "2025-11-22T18:32:31.383665Z", "level": "info"}
INFO     cubo:health_monitor.py:83 {"event": "Added health check: system_cpu", "timestamp": "2025-11-22T18:32:31.383665Z", "level": "info"}
INFO     cubo:health_monitor.py:83 {"event": "Added health check: disk_space", "timestamp": "2025-11-22T18:32:31.384175Z", "level": "info"}
INFO     cubo:health_monitor.py:66 {"event": "HealthMonitor initialized", "timestamp": "2025-11-22T18:32:31.384175Z", "level": "info"}
INFO     cubo:health_monitor.py:83 {"event": "Added health check: thread_pool", "timestamp": "2025-11-22T18:32:31.384175Z", "level": "info"}
INFO     cubo:health_monitor.py:83 {"event": "Added health check: error_recovery", "timestamp": "2025-11-22T18:32:31.384175Z", "level": "info"}
INFO     src.cubo.services.service_manager:service_manager.py:39 ServiceManager initialized
INFO     cubo:test_logger_reconfig_and_trace.py:30 {"event": "background op", "timestamp": "2025-11-22T18:32:31.384741Z", "level": "info", "trace_id": "04fd3399-4a68-4b02-9259-0e02cadfa548"}
============================== warnings summary ===============================
..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\faiss\loader.py:28
  C:\Users\paolo\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\faiss\loader.py:28: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
    if LooseVersion(numpy.__version__) >= "1.19":

..\..\..\..\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\site-packages\setuptools\_distutils\version.py:346
  C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\site-packages\setuptools\_distutils\version.py:346: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
    other = LooseVersion(other)

..\..\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\pythonjsonlogger\jsonlogger.py:11
  C:\Users\paolo\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\site-packages\pythonjsonlogger\jsonlogger.py:11: DeprecationWarning: pythonjsonlogger.jsonlogger has been moved to pythonjsonlogger.json
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/logging/test_logger_reconfig_and_trace.py::test_logger_reconfig_json_and_trace - assert (False)
======================== 1 failed, 3 warnings in 0.36s ========================
